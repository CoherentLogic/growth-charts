function vistaLogin(accessCode, verifyCode, ewd) {


    
    var authP = new ewd.mumps.GlobalNode('%zewdTemp', [process.pid]);
    
    authP._delete();
    
    authP._setDocument({
	inputs:{
	    password: verifyCode,
	    username: accessCode
	}
    });
    
    var result = ewd.mumps.function('login^ZZCPCR00', '');



    if (result === '') {

	var document = authP._getDocument();

	return {
	    error: false,
	    outputs: document.outputs
	};

    }
    else {
	return {error: result};
    }

}


module.exports = {
    
    onMessage: {
	
	init: function(params, ewd) {
	    console.log("Server-side init started.");

	    if(params.inCPRS) {
		ewd.sendWebSocketMsg({
		    type: 'loggedIn',
		    message: {
			ok: true,
			name: "",
			patientPicker: false
		    }
		});
	    }

	    return({initialized: 1});
	},

	getChart: function(params, ewd) {
	    ewd.mumps.function("CHART^KBBMGC", params.dfn);
	    var chartNode = new ewd.mumps.GlobalNode("KBBMGC", [process.pid, "CHART", params.dfn]);
	    var doc = chartNode._getDocument();
	    chartNode._delete();
	    
	    return doc;
	},

	getPatients: function(params, ewd) {
	    var prefix = params.prefix || "";

	    var count = ewd.mumps.function("PATLIST^KBBMGC", prefix);
	    var patientsNode = new ewd.mumps.GlobalNode("KBBMGC", [process.pid, "PATIENTS"]);

	    var doc = patientsNode._getDocument();
	    patientsNode._delete();

	    return doc;
	},

	'EWD.form.login': function(params, ewd) {
	    if(params.username === "" || params.password === "") {
		return "Access Code and Verify Code are mandatory.";
	    }

	    var results = vistaLogin(params.username, params.password, ewd);

	    if(results.error) {
		return results.error;
	    }
	    else {



		ewd.session.$('username')._value = params.username;
		ewd.session.$('userDUZ')._value = results.outputs.DUZ;
		ewd.session.$('displayName')._value = results.outputs.displayName;

		ewd.sendWebSocketMsg({
		    type: 'loggedInAs',
		    message: {
			fullName: results.outputs.displayName
		    }
		});

		ewd.session.setAuthenticated();

		ewd.sendWebSocketMsg({
		    type: 'loggedIn',
		    message: {
			ok: true,
			name: ewd.session.$('displayName')._value,
			patientPicker: true
		    }
		});

		return '';

	    }
	}


    }

}